const n=document.getElementById("qr-video"),o=document.getElementById("qr-canvas"),d=o.getContext("2d"),s=document.getElementById("qr-result"),r=document.getElementById("start-scan-btn"),i=document.getElementById("qr-link"),g=document.getElementById("edit-link");let c=!1;async function h(){try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});n.srcObject=t,c=!0,requestAnimationFrame(l)}catch(t){console.error("Ошибка доступа к камере:",t),s.textContent="Не удалось получить доступ к камере."}}function l(){if(c&&n.readyState===n.HAVE_ENOUGH_DATA){o.width=n.videoWidth,o.height=n.videoHeight,d.drawImage(n,0,0,o.width,o.height);const t=d.getImageData(0,0,o.width,o.height),a=jsQR(t.data,t.width,t.height),m=document.getElementById("orpicker");a&&(s.textContent="Найдено: "+a.data,fetch("/handle-qr-scan",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({team_name:a.data})}).then(e=>e.json()).then(e=>{console.log("Ответ сервера:",e),e.success&&e.redirect_url?(console.log("Редирект URL:",e.redirect_url),g.href=e.redirect_url,i.style.display="block",i.style.opacity="1",m.style.display="block"):s.textContent="Ошибка: "+(e.message||"Некорректные данные от сервера")}).catch(e=>{console.error("Ошибка при отправке данных:",e),s.textContent="Ошибка при обработке QR-кода."}),c=!1,n.srcObject.getTracks().forEach(e=>e.stop()),r.textContent="Начать сканирование")}c&&requestAnimationFrame(l)}r.addEventListener("click",()=>{c?(c=!1,n.srcObject.getTracks().forEach(t=>t.stop()),r.textContent="Начать сканирование",s.textContent="Сканирование остановлено."):(h(),r.textContent="Остановить сканирование",i.style.display="none",i.style.opacity="0")});
